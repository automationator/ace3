{% extends "analysis/alert.html" %}
{% block alert_details %}

<div class="mb-4">
    {% if 'search_link' in analysis.details %}
        <div class="mb-3">
            <b><a href="{{ analysis.details['search_link'] }}" target="_blank" class="btn btn-primary btn-sm">
                <span class="bi bi-search"></span> Search in Splunk
            </a></b>
        </div>
        <div class="alert alert-info py-2">
            <small><strong>Note:</strong> If your Splunk search opens in the wrong app, make sure that <code>splunk_app_context</code> is properly set in your hunt config.</small>
        </div>
    {% elif 'search_id' in analysis.details %}
        <div class="mb-3">
            <b><a href="https://splunk/en-US/app/search/search?sid={{ analysis.details['search_id'] }}" target="_blank" class="btn btn-primary btn-sm">
                <span class="bi bi-search"></span> Search in Splunk
            </a></b>
        </div>
        <div class="alert alert-warning py-2">
            <small><strong>Note:</strong> Splunk searches expire quickly -- <i>(Unknown sid)</i> -- in this case, copy the query generated for this alert below to reproduce original results.</small>
        </div>
    {% endif %}
</div>

{% if analysis.details.get("events", []) | length > 0 and 'query' in analysis.details %}
<div class="mb-4">
    <div class="d-flex align-items-center mb-2">
        <h6 class="mb-0 me-2">Original Query</h6>
        <button class="btn btn-secondary btn-sm" type="button" id="copy_action_splunk_{{ unique_reference }}" title="Copy to Clipboard"><span class="bi bi-copy"></span></button>
    </div>
    <script type="text/javascript">
        $('#copy_action_splunk_{{unique_reference}}').on('click', function () {
            // avoid escaping issues going from python to javascript by using base64
            let query_string = atob('{{analysis.details["query"] | s64encode}}');
            // see app/static/js/ace.js
            copy_to_clipboard(query_string);
            // let the user know it was copied by flashing it a bit
            $('#copy_action_{{unique_reference}}').effect("pulsate", {times: 3}, 500);
        });
    </script>

    <div class="p-4 bg-light border rounded raw-log" style="word-break:break-all; -webkit-text-size-adjust: 110%;">
        {% set query_split = analysis.details['query'].split('|') %}
        {{ query_split[0] }}<br>
        {% for line in query_split[1:] %}
            {% set line_tokens = line.strip().split(' ') %}
            &emsp;&emsp;| <span style="color: #2662FC">{{ line_tokens[0] }} </span>
            {% for tok in line_tokens[1:] %}
                {{ tok }}
            {% endfor %}<br>
        {% endfor %}
    </div>
</div>
{% endif %}

{% block splunk_hunt_details %}
{% endblock %}

<div class="card mt-4">
    <div class="card-header bg-white">
        <h5 class="card-title mb-0">
            Raw Splunk Details
            <a role="button" data-bs-toggle="collapse" data-bs-target="#collapse_raw_splunk_details_{{ unique_reference }}" aria-expanded="false" aria-controls="collapse_raw_splunk_details_{{ unique_reference }}" class="text-decoration-none ms-2">
                <small>(show/hide)</small>
            </a>
        </h5>
    </div>
    <div class="card-body p-4 bg-light raw-log collapse" id="collapse_raw_splunk_details_{{ unique_reference }}" style="word-break:break-all; -webkit-text-size-adjust: 110%">
        <div id="json-tree-{{ unique_reference }}"></div>
    </div>
</div>

<script type="text/javascript">
    // Uses renderJsonTree from app/static/js/ace.js
    renderJsonTree(
        {{ analysis.details.get("events", []) | tojson }},
        'json-tree-{{ unique_reference }}',
        { emptyMessage: 'No events data available' }
    );
</script>

{% endblock %}
