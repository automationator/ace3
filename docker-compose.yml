
#
# .env variables
#
#
# these set the default output docker image tags
# 
# ACE3_IMAGE_URL
# ACE3_PHISHKIT_MANAGER_IMAGE_URL
# ACE3_PHISHKIT_IMAGE_URL
#
# these allow you to override the default docker images
# useful if you are using some kind of a pass through docker image registry
#
# PYTHON_DOCKER_IMAGE
# MYSQL_DOCKER_IMAGE
# NGINX_DOCKER_IMAGE
# RABBITMQ_DOCKER_IMAGE
# MINIO_DOCKER_IMAGE
# MINIO_MC_DOCKER_IMAGE
# QDRANT_DOCKER_IMAGE
# DOCKER_IN_DOCKER_IMAGE
# UBUNTU_DOCKER_IMAGE
#
# password and configuration settings
# NOTE if these are not set they are auto-generated
#
# SAQ_ENC (primary encryption password)
# ACE_API_KEY (api key for node-to-node communication)
# ACE_DB_USER_PASSWORD (password for the ace-user database user)
# ACE_SUPERUSER_DB_USER_PASSWORD (password for the ace-superuser database user)
# REDIS_PASSWORD
# MINIO_PASSWORD
# RABBITMQ_PASSWORD
# QDRANT_API_KEY
#
# host name overrides if services are running on different hosts
# ACE_DB_HOST
# ACE_DB_READONLY_HOST
# RABBITMQ_HOSTNAME
# REDIS_HOSTNAME
# MINIO_HOSTNAME
# QDRANT_HOSTNAME
#
# configuration options
# SAQ_CONFIG_PATHS
#

x-common-env: &common-env
  SAQ_ENC: ${SAQ_ENC:-test}
  SAQ_CONFIG_PATHS: ${SAQ_CONFIG_PATHS:-}
  # if your primary database has a different hostname, you will need to pass it in as ACE_DB_HOST
  ACE_DB_HOST: ${ACE_DB_HOST:-ace-db}
  ACE_DB_READONLY_HOST: ${ACE_DB_READONLY_HOST:-ace-db-readonly}
  ACE_DB_USER_PASSWORD: ${ACE_DB_USER_PASSWORD:-}
  ACE_SUPERUSER_DB_USER_PASSWORD: ${ACE_SUPERUSER_DB_USER_PASSWORD:-}
  REDIS_PASSWORD: ${REDIS_PASSWORD:-}
  MINIO_PASSWORD: ${MINIO_PASSWORD:-}
  RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-}
  QDRANT_API_KEY: ${QDRANT_API_KEY:-}
  ACE_API_KEY: ${ACE_API_KEY:-}

x-common-volumes: &common-volumes
  - .:/opt/ace
  # NOTE your ssh keys are mounted read-only in all containers
  - ~/.ssh:/opt/ace/ssh:ro
  - ace-data:/opt/ace/data
  - ace-sql:/docker-entrypoint-initdb.d
  - ace-sql-readonly:/ace-sql-readonly
  - ace-yara:/opt/ace/etc/yara
  - ace-hunt:/opt/ace/hunts
  - ace-auth:/auth
  - ace-user-home:/home/ace

services:
  # ensures file permissions on named volumes are correct
  ace-root-volume-initialize:
    environment: *common-env
    user: root
    build:
      context: .
      args:
        PYTHON_DOCKER_IMAGE: ${PYTHON_DOCKER_IMAGE:-python:3.12-bookworm}
        SAQ_USER_ID: ${SAQ_USER_ID:-1000}
        SAQ_GROUP_ID: ${SAQ_GROUP_ID:-1000}
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    command: /bin/bash -c "/opt/ace/docker/startup/initialize_volumes.sh"
    volumes:
      - ace-data:/opt/ace/data
      - ace-sql:/docker-entrypoint-initdb.d
      - ace-sql-readonly:/ace-sql-readonly
      - ./ssl:/opt/ace/ssl
      - ace-auth:/auth
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  # performs all first-time initialization routines that do not require the db
  ace-initialize:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    command: /bin/bash -c "/opt/ace/docker/startup/initialize.sh"
    depends_on:
      ace-root-volume-initialize:
        condition: service_completed_successfully
    volumes: *common-volumes
    cap_add:
      - SYS_PTRACE
    hostname: ace
    networks: 
      - ace

  ace-db:
    image: ${MYSQL_DOCKER_IMAGE:-mysql:9.2}
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_520_ci --max-allowed-packet=1073741824
    healthcheck:
      test: ["CMD", "mysql", "--defaults-file=/docker-entrypoint-initdb.d/mysql_defaults", "-h", "${ACE_DB_HOST:-ace-db}", "-e", "use ace;"]
      interval: 3s
      retries: 5
      start_period: 30s
      timeout: 10s
    restart: always
    depends_on:
      ace-initialize:
        condition: service_completed_successfully
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 1
    volumes:
      - ace-db:/var/lib/mysql
      - ace-sql:/docker-entrypoint-initdb.d
      - ace-data:/opt/ace/data
      - ./etc/mysqld/conf.d:/etc/mysql/conf.d
      - ./ssl:/opt/ace/ssl
    ports:
      - "3306:3306"
    hostname: ${ACE_DB_HOST:-ace-db}
    networks: 
      - ace

  ace-db-readonly:
    image: ${MYSQL_DOCKER_IMAGE:-mysql:9.2}
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_520_ci --max-allowed-packet=1073741824
    healthcheck:
      test: ["CMD", "mysql", "--defaults-file=/docker-entrypoint-initdb.d/mysql_defaults", "-h", "${ACE_DB_READONLY_HOST:-ace-db-readonly}", "-e", "use ace;"]
      interval: 3s
      retries: 5
      start_period: 30s
      timeout: 10s
    restart: always
    depends_on:
      ace-db:
        condition: service_healthy
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 1
    volumes:
      - ace-db-readonly:/var/lib/mysql
      - ace-sql-readonly:/docker-entrypoint-initdb.d
      - ace-data:/opt/ace/data
      - ./etc/mysqld.replica/conf.d:/etc/mysql/conf.d
      - ./ssl:/opt/ace/ssl
    ports:
      - "3307:3306"
    hostname: ${ACE_DB_READONLY_HOST:-ace-db-readonly}
    networks: 
      - ace

  qdrant:
    environment:
      QDRANT__SERVICE__ENABLE_TLS: 1
      QDRANT__TLS__CERT: /ssl/ace.cert.pem
      QDRANT__TLS__KEY: /ssl/ace.key.pem
    image: ${QDRANT_DOCKER_IMAGE:-qdrant/qdrant}
    hostname: ${QDRANT_HOSTNAME:-qdrant}
    entrypoint: >
      /bin/sh -c "
      export QDRANT__SERVICE__API_KEY=$(cat /auth/passwords/qdrant) && ./entrypoint.sh
      "
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    ports:
      - "6333"
    volumes:
      - ace-qdrant:/qdrant/storage
      - ./ssl:/ssl:ro
      - ace-auth:/auth
    networks:
      - ace

  # performs all first-time initialization routines that require the db
  ace-setup:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    command: /bin/bash -c "/opt/ace/docker/startup/setup.sh"
    depends_on:
      ace-db:
        condition: service_healthy
    volumes: *common-volumes
    cap_add:
      - SYS_PTRACE
    hostname: ace
    networks: 
      - ace

  ace-http-external:
    image: ${NGINX_DOCKER_IMAGE:-nginx:latest}
    restart: always
    depends_on:
      - http-app
      - http-api
    volumes:
      - ./etc/nginx/conf.d.external:/etc/nginx/conf.d:ro
      - ./app/static:/opt/ace/app/static:ro
      - ./ssl:/opt/ace/ssl:ro
    hostname: ace-http-external
    ports:
      - "9443:443"
    networks: 
      - ace

  ace-http:
    image: ${NGINX_DOCKER_IMAGE:-nginx:latest}
    restart: always
    depends_on:
      - http-app
      - http-api
    volumes: 
      - ./etc/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./app/static:/opt/ace/app/static:ro
      - ./ssl:/opt/ace/ssl:ro
    hostname: ace-http
    ports:
      - "8443:443"
    networks: 
      - ace

  http-app:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      - ace
    command: /bin/bash -c "/opt/ace/docker/startup/start_uwsgi_app.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    expose:
      - "3030"
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  http-api:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      - ace
    command: /bin/bash -c "/opt/ace/docker/startup/start_uwsgi_api.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    expose:
      - "3031"
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  redis:
    image: ${REDIS_DOCKER_IMAGE:-redis:latest}
    ports:
      - "6379:6379"
    restart: always
    hostname: ${REDIS_HOSTNAME:-redis}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    # here we're loading the redis.conf that is built from the ace-setup container
    command: ["redis-server", "/auth/etc/redis/redis.conf"]
    volumes:
      - ace-auth:/auth
    networks: 
      - ace

  http-debug:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      - ace
    command: /bin/bash -c "/opt/ace/docker/startup/start_debug_gui.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    ports:
      - "5000:5000"
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  network-semaphore:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    command: /bin/bash -c "/opt/ace/docker/startup/start_network_semaphore.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    ports:
      - "53559:53559"
    networks: 
      - ace

  git:
    environment: *common-env
    depends_on:
      - ace
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    command: /bin/bash -c "/opt/ace/docker/startup/start_git.sh"
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  cron:
    environment: *common-env
    depends_on:
      - ace
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    command: /bin/bash -c "/opt/ace/docker/startup/start_yacron.sh"
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  yara:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    command: /bin/bash -c "/opt/ace/docker/startup/start_yara.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  background-executor:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace:
        condition: service_started
      redis:
        condition: service_started
    command: /bin/bash -c "/opt/ace/docker/startup/start_background_executor.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  embedding-service:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace:
        condition: service_started
      redis:
        condition: service_started
    command: /bin/bash -c "/opt/ace/docker/startup/start_embedding_service.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  dev:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    command: /bin/bash -c "/opt/ace/docker/startup/start_nothing.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    ports:
      - "5001:5000"
    networks: 
      - ace

  ace:
    environment: *common-env
    image: ${ACE3_IMAGE_URL:-ace3:latest}
    depends_on:
      ace-setup:
        condition: service_completed_successfully
      yara:
        condition: service_started
      network-semaphore:
        condition: service_started
      phishkit:
        condition: service_started
      qdrant:
        condition: service_started
    command: /bin/bash -c "/opt/ace/docker/startup/start_engine.sh"
    restart: always
    volumes: *common-volumes
    hostname: ace
    cap_add:
      - SYS_PTRACE
    networks: 
      - ace

  rabbitmq:
    environment:
      RABBITMQ_DEFAULT_USER: "ace3"
    image: ${RABBITMQ_DOCKER_IMAGE:-rabbitmq}
    ports:
      - "5672:5672"
    restart: always
    hostname: ${RABBITMQ_HOSTNAME:-rabbitmq}
    entrypoint: >
      /bin/sh -c "
      export RABBITMQ_DEFAULT_PASS=$(cat /auth/passwords/rabbitmq);
      exec rabbitmq-server
      "
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    volumes:
      - ace-auth:/auth
    networks:
      - ace

  minio:
    environment:
      MINIO_ROOT_USER: "ace3"
    image: ${MINIO_DOCKER_IMAGE:-minio/minio:latest}
    restart: always
    hostname: ${MINIO_HOSTNAME:-minio}
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # MinIO console
    entrypoint: >
      /bin/sh -c "
      export MINIO_ROOT_PASSWORD=$(cat /auth/passwords/minio) && exec minio server /data --console-address :9001
      "
    volumes:
      - ace-minio:/data
      - ace-minio-events:/opt/minio/events
      - ace-auth:/auth
    healthcheck:
      test: ["CMD", "curl", "-f", "http://${MINIO_HOSTNAME:-minio}:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 40s
    depends_on:
      ace-setup:
        condition: service_completed_successfully
    networks:
      - ace

  minio-init:
    environment:
      RABBITMQ_HOSTNAME: ${RABBITMQ_HOSTNAME:-rabbitmq}
    image: ${MINIO_MC_DOCKER_IMAGE:-minio/mc:latest}
    depends_on:
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    entrypoint: /tmp/minio-init.sh
    volumes:
      - ace-minio:/data
      - ace-minio-events:/opt/minio/events
      - ace-auth:/auth
      - ./bin/minio-init.sh:/tmp/minio-init.sh
    networks:
      - ace

  phishkit-init:
    build:
      context: ./phishkit
      dockerfile: Dockerfile.phishkit
      args:
        UBUNTU_DOCKER_IMAGE: ${UBUNTU_DOCKER_IMAGE:-ubuntu:22.04}
    image: ${ACE3_PHISHKIT_IMAGE_URL:-phishkit:latest}
    # this is here just to build the image
    entrypoint: /bin/true

  phishkit:
    environment:
      MINIO_HOST: ${MINIO_HOSTNAME:-minio}
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ace3api
    hostname: phishkit
    build:
      context: ./phishkit
      args:
        DOCKER_IN_DOCKER_IMAGE: ${DOCKER_IN_DOCKER_IMAGE:-docker:dind}
    image: ${ACE3_PHISHKIT_MANAGER_IMAGE_URL:-phishkit-manager:latest}
    depends_on:
      phishkit-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      # this is needed so that this container can create other containers
      - /var/run/docker.sock:/var/run/docker.sock
      # this volume is used to share the downloaded data between the child containers and this one
      - ace-phishkit:/phishkit
      # this volume contains authentication information
      - ace-auth:/auth
    networks:
      - ace


volumes:
  ace-data:
    name: ace-data
  ace-db:
    name: ace-db
  ace-db-readonly:
    name: ace-db-readonly
  ace-sql:
    name: ace-sql
  ace-sql-readonly:
    name: ace-sql-readonly
  ace-yara:
    name: ace-yara
  ace-hunt:
    name: ace-hunt
  ace-minio:
    name: ace-minio
  ace-minio-events:
    name: ace-minio-events
  ace-phishkit:
    name: ace-phishkit
  ace-auth:
    name: ace-auth
  ace-qdrant:
    name: ace-qdrant
  ace-user-home:
    name: ace-user-home

networks:
  ace:
